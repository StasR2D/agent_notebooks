# README

## 1. Общие сведения

Проект посвящён разработке интеллектуального агента для анализа банковских операций и выявления подозрительных транзакций.  
Основная цель – создать систему, способную не только классифицировать операции по степени риска, но и объяснять свои выводы в понятной для специалиста форме.

Работа велась последовательно: от первоначальной модели машинного обучения до реализации трёхслойного алгоритма аномалий. Ниже описан ход исследования и принятые решения.


## 2. Первая версия: модель классификации

На начальном этапе использовалась типовая модель машинного обучения (supervised), обученная на размеченных данных.  
Входные признаки включали сумму операции, частоту, назначение платежа, типы контрагентов и ряд поведенческих характеристик.  
Выходом модели была метрика `ml_metric` – вероятность подозрительности операции.

### Основные проблемы

- слабая обобщающая способность, переобучение на старых схемах  
- низкий recall и пропуск новых форм мошенничества  
- отсутствие интерпретируемости (модель не объясняла решения)  
- не использовалась история клиента и контрагентов  

Система показала неудовлетворительные результаты и оказалась непригодной для комплаенса.


## 3. Анализ критериев и нормативной базы

Ключевые факторы:

- краткосрочное пребывание средств на счёте (транзит)  
- многочисленные однотипные переводы  
- рост числа контрагентов  
- круглые суммы  
- чрезмерная частота операций  
- отсутствие регулярных бытовых платежей  
- двусторонняя торговля между контрагентами  
- признаки компаний-однодневок и аффилированности
- Перечень слов стоп-факторов, при которых срабатывает триггер выского риска

Эти признаки легли в основу новой архитектуры и структуры данных.


## 4. Переход к трёхслойной архитектуре

После анализа принято решение отказаться от единой модели классификации и перейти к системе, которая охватывет аномальное поведение конкретного клиента, общие аномалии и графовый анализ.


## 5. Слой 1. Аномалистический анализ

Первый слой объединяет несколько независимых методов без обучения на размеченных данных. Он состоит из трёх подсистем.

### 1A. Поведенческая аномалистика

Для каждого клиента формируется модель Isolation Forest, обученная на его собственных транзакциях.  
Если данных недостаточно, используется глобальная модель по всей выборке.  
Результат – `behavior_score`, отражающий степень отклонения операции от обычного поведения клиента.  
Используются признаки суммы, относительных отклонений, количества контрагентов, дневных и скользящих счётчиков.  
Оценки глобальной и локальной моделей объединяются логарифмически, чтобы учитывать как поведение конкретного клиента, так и общие закономерности.

### 1B. Глобальные выбросы

Применяется алгоритм HBOS (Histogram-Based Outlier Score) или COPOD.  
Он анализирует распределения признаков по всей выборке транзакций и выделяет статистические аномалии.  
Результат – `global_anomaly_score`.  
Метод обеспечивает высокую скорость и устойчивость при больших объёмах данных.

### 1C. Графовый анализ

Анализируется сеть переводов между счетами.  
Используются признаки степени узлов, взаимных переводов, работы с новыми контрагентами и длительности цепочек прохождения средств.  
Результат – `graph_score`, рассчитываемый либо логистической регрессией (при наличии слабых меток), либо нормированным средним.  
Этот слой фиксирует сетевые схемы – транзит, обналичивание, кольцевые переводы.

На выходе слоя формируется общий показатель:

anomaly_overall = max(behavior_score, global_anomaly_score, graph_score)

## 6. Слой 2. Историческая память и контекст

Второй слой добавляет память и контекст.  
Он использует накопленные данные о клиентах и контрагентах:

- `*_susp_rate` – доля подозрительных операций  
- `*_cnt_suspicious` – количество флагов  
- `*_watchlisted`, `*_p95`, `*_last_seen_days`  

Эти данные корректируют первичные аномалии: постоянное поведение снижает риск, плохая история его увеличивает.  
На этой стадии рассчитывается интегральный показатель риска:

risk_score = max(
0.8 * anomaly_overall,
0.85 if transit_short else 0,
0.25 * purpose_stopword_high,
0.25 if watchlisted else 0
)


`risk_label` определяется по порогам:
- ≥ 0.70 — высокий риск (красный)  
- 0.40–0.69 — средний риск (жёлтый)  
- < 0.40 — низкий риск (зелёный)  


## 7. Слой 3. Интерпретация и вывод (LLM)

Третий слой формирует объяснения и рекомендации.  
Используется языковая модель GigaChat, работающая по системному промпту.  
Промпт задаёт правила оценки и формат вывода JSON.



## 8. Формат итогового отчёта

Результаты анализа формируются в виде таблицы.  
Основной лист «Выписка» содержит все операции с указанием даты, суммы, контрагента, назначения, уровня риска, пояснения и рекомендации.  
Операции выделяются цветом:

- зелёный — низкий риск  
- жёлтый — средний риск  
- красный — высокий риск  

Отдельный лист "Подозрительные" содержит операции, по которым слои определили разный уровень подозрительности для транзакции.


## 9. Научная обоснованность

Используемые методы и архитектурные решения опираются на современные исследования в области финансового мониторинга.

- Isolation Forest — эффективен при отсутствии разметки и обеспечивает высокую полноту выявлений  
- HBOS и COPOD — быстрые алгоритмы для потоковых данных  
- графовые признаки отражают реальные схемы транзитных переводов и аффилированности  
- использование памяти снижает количество ложных срабатываний и стабилизирует модель  
- языковая модель (LLM) обеспечивает объяснимость и соответствие требованиям регуляторов  

Таким образом, реализованная архитектура сочетает статистическую строгость, устойчивость к новым схемам и прозрачность решений, что делает её применимой для задач финансового мониторинга.




